---
title: "MLB Pitches"
author: "Zhicong Fan (zhicong2@illinois.edu)"
date: "11/29/2020"
output:
  html_document: 
    theme: default
    toc: yes
---

```{r, setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align = 'center')
```

```{r, load-packages, include = FALSE}
# load packages
library("tidyverse")
library("caret")
library("rpart")
library("rpart.plot")
library("PRROC")
library("ROCR")
library("MLmetrics")
library("xgboost")
library("archdata")
library("dplyr")
library("Ckmeans.1d.dp")
library("Matrix")
```

```{r read-data, warning = FALSE, message = FALSE}
# read subset of data
pitches_2020_regular = readr::read_csv("data/pitches_2020_regular.csv")
pitches_2020_missing = readr::read_csv("data/pitches_2020_missing.csv")
pitches_2020_post = readr::read_csv("data/pitches_2020_post.csv")
sapply(pitches_2020_regular, class)
pitches_2020_regular = subset(pitches_2020_regular, select = -c(game_date,batter,pitcher))
pitches_2020_post = subset(pitches_2020_post, select = -c(game_date,batter,pitcher))
pitches_2020_missing = subset(pitches_2020_missing, select = -c(game_date,batter,pitcher))
```

***

## Abstract

> Baseball is an incredibly data-driven sport and we want to help with the future analyses.

***

## Introduction

Baseball is an interesting sport and even though I know little about this sport. I would like to dive into the dataset and explore more about predicting what type of ball is thrown. In this last analysis, I would like to apply the boosting strategy I learned in my research: XGBoost.

***

## Methods

Besides the knn and tree models, I am going to use XGB model in my final analysis.

### Data

There are 7 classes in this dataset: CH, CU, FF, FC FS, SI and SL. For the parameters, I am only going to use those except for batter, pitcher and game_date since these are either no relevant to my prediction or there exists another parameter could replace its role.

### Modeling

```{r}
# Creating Train/Test dataset
set.seed((42))
trn_idx = createDataPartition(pitches_2020_regular$pitch_type, p = 0.80, list = TRUE)
pitch_regular_trn = pitches_2020_regular[trn_idx$Resample1, ]
pitch_regular_tst = pitches_2020_regular[-trn_idx$Resample1, ]

trn_idx_post = createDataPartition(pitches_2020_post$pitch_type, p = 0.80, list = TRUE)
pitch_post_trn = pitches_2020_post[trn_idx_post$Resample1, ]
pitch_post_tst = pitches_2020_post[-trn_idx_post$Resample1, ]

table(pitch_regular_trn$pitch_type)
table(pitch_post_trn$pitch_type)
summary(pitch_regular_trn)
```
```{r}

pitches_2020_regular$pitch_type <- as.numeric(factor(pitches_2020_regular$pitch_type))
pitches_2020_regular$player_name <- as.numeric(factor(pitches_2020_regular$player_name))
pitches_2020_regular$stand <- as.numeric(factor(pitches_2020_regular$stand))
pitches_2020_regular$p_throws <- as.numeric(factor(pitches_2020_regular$p_throws))

dat <- pitches_2020_regular %>%
  mutate(pitch_type = pitch_type - 1)


train_index_xgboost <- sample(1:nrow(dat), nrow(dat)*0.8)

data_variables <- as.matrix(dat[,-1])
data_label <- as.matrix(dat$pitch_type)
data_matrix <- xgb.DMatrix(data = as.matrix(dat), label = data_label)

train_data   <- data_variables[train_index_xgboost,]
train_label  <- data_label[train_index_xgboost]
train_matrix <- xgb.DMatrix(data = train_data, label = train_label)

test_data  <- data_variables[-train_index_xgboost,]
test_label <- data_label[-train_index_xgboost]
test_matrix <- xgb.DMatrix(data = test_data, label = test_label)
```

```{r}
numberOfClasses <- length(unique(dat$pitch_type))
xgb_params <- list("objective" = "multi:softprob",
                   "eval_metric" = "mlogloss",
                   "num_class" = numberOfClasses)
nround    <- 50
cv.nfold  <- 5


cv_model <- xgb.cv(params = xgb_params,
                   data = train_matrix, 
                   nrounds = nround,
                   nfold = cv.nfold,
                   verbose = FALSE,
                   prediction = TRUE)
```

***
```{r}
OOF_prediction <- data.frame(cv_model$pred) %>%
  mutate(max_prob = max.col(., ties.method = "last"),
         label = train_label + 1)
head(OOF_prediction)
```

```{r}
confusionMatrix(factor(OOF_prediction$max_prob),
                factor(OOF_prediction$label),
                mode = "everything")
```

```{r}
bst_model <- xgb.train(params = xgb_params,
                       data = train_matrix,
                       nrounds = nround)

test_pred <- predict(bst_model, newdata = test_matrix)
test_prediction <- matrix(test_pred, nrow = numberOfClasses,
                          ncol=length(test_pred)/numberOfClasses) %>%
  t() %>%
  data.frame() %>%
  mutate(label = test_label + 1,
         max_prob = max.col(., "last"))

confusionMatrix(factor(test_prediction$max_prob),
                factor(test_prediction$label),
                mode = "everything")
```

```{r}
names <-  colnames(dat[,-1])
importance_matrix = xgb.importance(feature_names = names, model = bst_model)
head(importance_matrix)
```
```{r}
gp = xgb.ggplot.importance(importance_matrix)
print(gp) 
```
```{r}
pitches_2020_post$pitch_type <- as.numeric(factor(pitches_2020_post$pitch_type))
pitches_2020_post$player_name <- as.numeric(factor(pitches_2020_post$player_name))
pitches_2020_post$stand <- as.numeric(factor(pitches_2020_post$stand))
pitches_2020_post$p_throws <- as.numeric(factor(pitches_2020_post$p_throws))

dat_post <- pitches_2020_post %>%
  mutate(pitch_type = pitch_type - 1)

data_variables_post <- as.matrix(dat_post[,-1])
data_label_post <- as.matrix(dat_post$pitch_type)
data_matrix_post <- xgb.DMatrix(data = as.matrix(dat_post), label = data_label_post)

test_data_post   <- data_variables_post
test_label_post  <- data_label_post
test_matrix_post <- xgb.DMatrix(data = test_data_post, label = test_label_post)
```

```{r}
test_pred_post <- predict(bst_model, newdata = test_matrix_post)
test_prediction_post <- matrix(test_pred_post, nrow = numberOfClasses,
                          ncol=length(test_pred_post)/numberOfClasses) %>%
  t() %>%
  data.frame() %>%
  mutate(label = test_label_post + 1,
         max_prob = max.col(., "last"))

confusionMatrix(factor(test_prediction_post$max_prob),
                factor(test_prediction_post$label),
                mode = "everything")


```
```{r}
pitches_2020_missing$pitch_type <- as.numeric(factor(pitches_2020_missing$pitch_type))
pitches_2020_missing$player_name <- as.numeric(factor(pitches_2020_missing$player_name))
pitches_2020_missing$stand <- as.numeric(factor(pitches_2020_missing$stand))
pitches_2020_missing$p_throws <- as.numeric(factor(pitches_2020_missing$p_throws))

dat_missing <- pitches_2020_missing %>%
  mutate(pitch_type = pitch_type - 1)

data_variables_missing <- as.matrix(dat_missing[,-1])
data_label_missing <- as.matrix(dat_missing$pitch_type)
data_matrix_missing <- xgb.DMatrix(data = as.matrix(dat_missing), label = data_label_missing)

test_data_missing   <- data_variables_missing
test_label_missing  <- data_label_missing
test_matrix_missing <- xgb.DMatrix(data = test_data_missing, label = test_label_missing)

test_pred_missing <- predict(bst_model, newdata = test_matrix_missing)
test_prediction_missing <- matrix(test_pred_missing, nrow = numberOfClasses,
                          ncol=length(test_pred_missing)/numberOfClasses) %>%
  t() %>%
  data.frame() %>%
  mutate(label = test_label_missing + 1,
         max_prob = max.col(., "last"))
```


## Results

To my surprise, the most significant factors are a_z, a_x and pfx_z. I thought the player himself would have great effect on the result at the first time.

***

## Discussion

Using all the regular data, I achieved an accuracy of 89% of both predicting test data split from the regular season and the test data constructed by the whole post season. For the missing data, the max probability is the 6th move which is "SI".

***

## Appendix

Place potential additional information here.
