knitr::opts_chunk$set(echo = FALSE, fig.align = 'center')
# load packages
library("tidyverse")
library("caret")
library("rpart")
library("rpart.plot")
library("PRROC")
library("ROCR")
library("MLmetrics")
library("xgboost")
library("archdata")
library("dplyr")
library("Ckmeans.1d.dp")
library("Matrix")
# read subset of data
pitches_2020_regular = readr::read_csv("data/pitches_2020_regular.csv")
pitches_2020_missing = readr::read_csv("data/pitches_2020_missing.csv")
pitches_2020_post = readr::read_csv("data/pitches_2020_post.csv")
sapply(pitches_2020_regular, class)
pitches_2020_regular = subset(pitches_2020_regular, select = -c(game_date,batter,pitcher))
pitches_2020_post = subset(pitches_2020_post, select = -c(game_date,batter,pitcher))
# Creating Train/Test dataset
set.seed((42))
trn_idx = createDataPartition(pitches_2020_regular$pitch_type, p = 0.80, list = TRUE)
pitch_regular_trn = pitches_2020_regular[trn_idx$Resample1, ]
pitch_regular_tst = pitches_2020_regular[-trn_idx$Resample1, ]
trn_idx_post = createDataPartition(pitches_2020_post$pitch_type, p = 0.80, list = TRUE)
pitch_post_trn = pitches_2020_post[trn_idx_post$Resample1, ]
pitch_post_tst = pitches_2020_post[-trn_idx_post$Resample1, ]
table(pitch_regular_trn$pitch_type)
table(pitch_post_trn$pitch_type)
summary(pitch_regular_trn)
pitches_2020_regular$pitch_type <- as.numeric(factor(pitches_2020_regular$pitch_type))
pitches_2020_regular$player_name <- as.numeric(factor(pitches_2020_regular$player_name))
pitches_2020_regular$stand <- as.numeric(factor(pitches_2020_regular$stand))
pitches_2020_regular$p_throws <- as.numeric(factor(pitches_2020_regular$p_throws))
dat <- pitches_2020_regular %>%
mutate(pitch_type = pitch_type - 1)
train_index_xgboost <- sample(1:nrow(dat), nrow(dat)*0.8)
data_variables <- as.matrix(dat[,-1])
data_label <- as.matrix(dat$pitch_type)
data_matrix <- xgb.DMatrix(data = as.matrix(dat), label = data_label)
train_data   <- data_variables[train_index_xgboost,]
train_label  <- data_label[train_index_xgboost]
train_matrix <- xgb.DMatrix(data = train_data, label = train_label)
test_data  <- data_variables[-train_index_xgboost,]
test_label <- data_label[-train_index_xgboost]
test_matrix <- xgb.DMatrix(data = test_data, label = test_label)
numberOfClasses <- length(unique(dat$pitch_type))
xgb_params <- list("objective" = "multi:softprob",
"eval_metric" = "mlogloss",
"num_class" = numberOfClasses)
nround    <- 50
cv.nfold  <- 5
cv_model <- xgb.cv(params = xgb_params,
data = train_matrix,
nrounds = nround,
nfold = cv.nfold,
verbose = FALSE,
prediction = TRUE)
OOF_prediction <- data.frame(cv_model$pred) %>%
mutate(max_prob = max.col(., ties.method = "last"),
label = train_label + 1)
head(OOF_prediction)
confusionMatrix(factor(OOF_prediction$max_prob),
factor(OOF_prediction$label),
mode = "everything")
bst_model <- xgb.train(params = xgb_params,
data = train_matrix,
nrounds = nround)
test_pred <- predict(bst_model, newdata = test_matrix)
test_prediction <- matrix(test_pred, nrow = numberOfClasses,
ncol=length(test_pred)/numberOfClasses) %>%
t() %>%
data.frame() %>%
mutate(label = test_label + 1,
max_prob = max.col(., "last"))
confusionMatrix(factor(test_prediction$max_prob),
factor(test_prediction$label),
mode = "everything")
names <-  colnames(dat[,-1])
importance_matrix = xgb.importance(feature_names = names, model = bst_model)
head(importance_matrix)
gp = xgb.ggplot.importance(importance_matrix)
print(gp)
names <-  colnames(dat[,-1])
importance_matrix = xgb.importance(feature_names = names, model = bst_model)
head(importance_matrix)
importance_matrix_2 = xgb.importance(feature_names = names, model = cv_model)
names <-  colnames(dat[,-1])
importance_matrix = xgb.importance(feature_names = names, model = bst_model)
head(importance_matrix)
pitches_2020_post$pitch_type <- as.numeric(factor(pitches_2020_post$pitch_type))
pitches_2020_post$player_name <- as.numeric(factor(pitches_2020_post$player_name))
pitches_2020_post$stand <- as.numeric(factor(pitches_2020_post$stand))
pitches_2020_post$p_throws <- as.numeric(factor(pitches_2020_post$p_throws))
dat_post <- pitches_2020_post %>%
mutate(pitch_type = pitch_type - 1)
data_variables_post <- as.matrix(dat_post[,-1])
data_label_post <- as.matrix(dat_post$pitch_type)
data_matrix_post <- xgb.DMatrix(data = as.matrix(dat_post), label = data_label_post)
test_data_post   <- data_variables_post
test_label_post  <- data_label_post
test_matrix_post <- xgb.DMatrix(data = test_data_post, label = test_label_post)
test_pred_post <- predict(bst_model, newdata = test_matrix_post)
test_prediction_post <- matrix(test_pred_post, nrow = numberOfClasses,
ncol=length(test_pred_post)/numberOfClasses) %>%
t() %>%
data.frame() %>%
mutate(label = test_label_post + 1,
max_prob = max.col(., "last"))
confusionMatrix(factor(test_prediction_post$max_prob),
factor(test_prediction_post$label),
mode = "everything")
pitches_2020_missing
# read subset of data
pitches_2020_regular = readr::read_csv("data/pitches_2020_regular.csv")
pitches_2020_missing = readr::read_csv("data/pitches_2020_missing.csv")
pitches_2020_post = readr::read_csv("data/pitches_2020_post.csv")
sapply(pitches_2020_regular, class)
pitches_2020_regular = subset(pitches_2020_regular, select = -c(game_date,batter,pitcher))
pitches_2020_post = subset(pitches_2020_post, select = -c(game_date,batter,pitcher))
# read subset of data
pitches_2020_regular = readr::read_csv("data/pitches_2020_regular.csv")
pitches_2020_missing = readr::read_csv("data/pitches_2020_missing.csv")
pitches_2020_post = readr::read_csv("data/pitches_2020_post.csv")
sapply(pitches_2020_regular, class)
pitches_2020_regular = subset(pitches_2020_regular, select = -c(game_date,batter,pitcher))
pitches_2020_post = subset(pitches_2020_post, select = -c(game_date,batter,pitcher))
pitches_2020_missing = subset(pitches_2020_missing, select = -c(game_date,batter,pitcher))
knitr::opts_chunk$set(echo = FALSE, fig.align = 'center')
# load packages
library("tidyverse")
library("caret")
library("rpart")
library("rpart.plot")
library("PRROC")
library("ROCR")
library("MLmetrics")
library("xgboost")
library("archdata")
library("dplyr")
library("Ckmeans.1d.dp")
library("Matrix")
# read subset of data
pitches_2020_regular = readr::read_csv("data/pitches_2020_regular.csv")
pitches_2020_missing = readr::read_csv("data/pitches_2020_missing.csv")
pitches_2020_post = readr::read_csv("data/pitches_2020_post.csv")
sapply(pitches_2020_regular, class)
pitches_2020_regular = subset(pitches_2020_regular, select = -c(game_date,batter,pitcher))
pitches_2020_post = subset(pitches_2020_post, select = -c(game_date,batter,pitcher))
pitches_2020_missing = subset(pitches_2020_missing, select = -c(game_date,batter,pitcher))
# Creating Train/Test dataset
set.seed((42))
trn_idx = createDataPartition(pitches_2020_regular$pitch_type, p = 0.80, list = TRUE)
pitch_regular_trn = pitches_2020_regular[trn_idx$Resample1, ]
pitch_regular_tst = pitches_2020_regular[-trn_idx$Resample1, ]
trn_idx_post = createDataPartition(pitches_2020_post$pitch_type, p = 0.80, list = TRUE)
pitch_post_trn = pitches_2020_post[trn_idx_post$Resample1, ]
pitch_post_tst = pitches_2020_post[-trn_idx_post$Resample1, ]
table(pitch_regular_trn$pitch_type)
table(pitch_post_trn$pitch_type)
summary(pitch_regular_trn)
pitches_2020_regular$pitch_type <- as.numeric(factor(pitches_2020_regular$pitch_type))
pitches_2020_regular$player_name <- as.numeric(factor(pitches_2020_regular$player_name))
pitches_2020_regular$stand <- as.numeric(factor(pitches_2020_regular$stand))
pitches_2020_regular$p_throws <- as.numeric(factor(pitches_2020_regular$p_throws))
dat <- pitches_2020_regular %>%
mutate(pitch_type = pitch_type - 1)
train_index_xgboost <- sample(1:nrow(dat), nrow(dat)*0.8)
data_variables <- as.matrix(dat[,-1])
data_label <- as.matrix(dat$pitch_type)
data_matrix <- xgb.DMatrix(data = as.matrix(dat), label = data_label)
train_data   <- data_variables[train_index_xgboost,]
train_label  <- data_label[train_index_xgboost]
train_matrix <- xgb.DMatrix(data = train_data, label = train_label)
test_data  <- data_variables[-train_index_xgboost,]
test_label <- data_label[-train_index_xgboost]
test_matrix <- xgb.DMatrix(data = test_data, label = test_label)
numberOfClasses <- length(unique(dat$pitch_type))
xgb_params <- list("objective" = "multi:softprob",
"eval_metric" = "mlogloss",
"num_class" = numberOfClasses)
nround    <- 50
cv.nfold  <- 5
cv_model <- xgb.cv(params = xgb_params,
data = train_matrix,
nrounds = nround,
nfold = cv.nfold,
verbose = FALSE,
prediction = TRUE)
OOF_prediction <- data.frame(cv_model$pred) %>%
mutate(max_prob = max.col(., ties.method = "last"),
label = train_label + 1)
head(OOF_prediction)
confusionMatrix(factor(OOF_prediction$max_prob),
factor(OOF_prediction$label),
mode = "everything")
bst_model <- xgb.train(params = xgb_params,
data = train_matrix,
nrounds = nround)
test_pred <- predict(bst_model, newdata = test_matrix)
test_prediction <- matrix(test_pred, nrow = numberOfClasses,
ncol=length(test_pred)/numberOfClasses) %>%
t() %>%
data.frame() %>%
mutate(label = test_label + 1,
max_prob = max.col(., "last"))
confusionMatrix(factor(test_prediction$max_prob),
factor(test_prediction$label),
mode = "everything")
names <-  colnames(dat[,-1])
importance_matrix = xgb.importance(feature_names = names, model = bst_model)
head(importance_matrix)
gp = xgb.ggplot.importance(importance_matrix)
print(gp)
pitches_2020_post$pitch_type <- as.numeric(factor(pitches_2020_post$pitch_type))
pitches_2020_post$player_name <- as.numeric(factor(pitches_2020_post$player_name))
pitches_2020_post$stand <- as.numeric(factor(pitches_2020_post$stand))
pitches_2020_post$p_throws <- as.numeric(factor(pitches_2020_post$p_throws))
dat_post <- pitches_2020_post %>%
mutate(pitch_type = pitch_type - 1)
data_variables_post <- as.matrix(dat_post[,-1])
data_label_post <- as.matrix(dat_post$pitch_type)
data_matrix_post <- xgb.DMatrix(data = as.matrix(dat_post), label = data_label_post)
test_data_post   <- data_variables_post
test_label_post  <- data_label_post
test_matrix_post <- xgb.DMatrix(data = test_data_post, label = test_label_post)
test_pred_post <- predict(bst_model, newdata = test_matrix_post)
test_prediction_post <- matrix(test_pred_post, nrow = numberOfClasses,
ncol=length(test_pred_post)/numberOfClasses) %>%
t() %>%
data.frame() %>%
mutate(label = test_label_post + 1,
max_prob = max.col(., "last"))
confusionMatrix(factor(test_prediction_post$max_prob),
factor(test_prediction_post$label),
mode = "everything")
pitches_2020_missing$pitch_type <- as.numeric(factor(pitches_2020_missing$pitch_type))
pitches_2020_missing$player_name <- as.numeric(factor(pitches_2020_missing$player_name))
pitches_2020_missing$stand <- as.numeric(factor(pitches_2020_missing$stand))
pitches_2020_missing$p_throws <- as.numeric(factor(pitches_2020_missing$p_throws))
dat_missing <- pitches_2020_missing %>%
mutate(pitch_type = pitch_type - 1)
data_variables_missing <- as.matrix(dat_missing[,-1])
data_label_missing <- as.matrix(dat_missing$pitch_type)
data_matrix_missing <- xgb.DMatrix(data = as.matrix(dat_missing), label = data_label_missing)
test_data_missing   <- data_variables_missing
test_label_missing  <- data_label_missing
test_matrix_missing <- xgb.DMatrix(data = test_data_missing, label = test_label_missing)
test_pred_missing <- predict(bst_model, newdata = test_matrix_missing)
test_prediction_missing <- matrix(test_pred_missing, nrow = numberOfClasses,
ncol=length(test_pred_missing)/numberOfClasses) %>%
t() %>%
data.frame() %>%
mutate(label = test_label_missing + 1,
max_prob = max.col(., "last"))
confusionMatrix(factor(test_prediction_missing$max_prob),
factor(test_prediction_missing$label),
mode = "everything")
pitches_2020_missing$pitch_type <- as.numeric(factor(pitches_2020_missing$pitch_type))
pitches_2020_missing$player_name <- as.numeric(factor(pitches_2020_missing$player_name))
pitches_2020_missing$stand <- as.numeric(factor(pitches_2020_missing$stand))
pitches_2020_missing$p_throws <- as.numeric(factor(pitches_2020_missing$p_throws))
dat_missing <- pitches_2020_missing %>%
mutate(pitch_type = pitch_type - 1)
data_variables_missing <- as.matrix(dat_missing[,-1])
data_label_missing <- as.matrix(dat_missing$pitch_type)
data_matrix_missing <- xgb.DMatrix(data = as.matrix(dat_missing), label = data_label_missing)
test_data_missing   <- data_variables_missing
test_label_missing  <- data_label_missing
test_matrix_missing <- xgb.DMatrix(data = test_data_missing, label = test_label_missing)
test_pred_missing <- predict(bst_model, newdata = test_matrix_missing)
test_prediction_missing <- matrix(test_pred_missing, nrow = numberOfClasses,
ncol=length(test_pred_missing)/numberOfClasses) %>%
t() %>%
data.frame() %>%
mutate(label = test_label_missing + 1,
max_prob = max.col(., "last"))
test_pred_missing
test_prediction_missing
test_pred_missing
pitches_2020_missing$pitch_type <- as.numeric(factor(pitches_2020_missing$pitch_type))
pitches_2020_missing$player_name <- as.numeric(factor(pitches_2020_missing$player_name))
pitches_2020_missing$stand <- as.numeric(factor(pitches_2020_missing$stand))
pitches_2020_missing$p_throws <- as.numeric(factor(pitches_2020_missing$p_throws))
dat_missing <- pitches_2020_missing %>%
mutate(pitch_type = pitch_type - 1)
data_variables_missing <- as.matrix(dat_missing[,-1])
data_label_missing <- as.matrix(dat_missing$pitch_type)
data_matrix_missing <- xgb.DMatrix(data = as.matrix(dat_missing), label = data_label_missing)
test_data_missing   <- data_variables_missing
test_label_missing  <- data_label_missing
test_matrix_missing <- xgb.DMatrix(data = test_data_missing, label = test_label_missing)
test_pred_missing <- predict(bst_model, newdata = test_matrix_missing)
test_prediction_missing <- matrix(test_pred_missing, nrow = numberOfClasses,
ncol=length(test_pred_missing)/numberOfClasses) %>%
t() %>%
data.frame() %>%
mutate(label = test_label_missing + 1,
max_prob = max.col(., "last"))
pitches_2020_missing$pitch_type <- as.numeric(factor(pitches_2020_missing$pitch_type))
pitches_2020_missing$player_name <- as.numeric(factor(pitches_2020_missing$player_name))
pitches_2020_missing$stand <- as.numeric(factor(pitches_2020_missing$stand))
pitches_2020_missing$p_throws <- as.numeric(factor(pitches_2020_missing$p_throws))
dat_missing <- pitches_2020_missing %>%
mutate(pitch_type = pitch_type - 1)
data_variables_missing <- as.matrix(dat_missing[,-1])
data_label_missing <- as.matrix(dat_missing$pitch_type)
data_matrix_missing <- xgb.DMatrix(data = as.matrix(dat_missing), label = data_label_missing)
test_data_missing   <- data_variables_missing
test_label_missing  <- data_label_missing
test_matrix_missing <- xgb.DMatrix(data = test_data_missing, label = test_label_missing)
test_pred_missing <- predict(bst_model, newdata = test_matrix_missing)
test_prediction_missing <- matrix(test_pred_missing, nrow = numberOfClasses,
ncol=length(test_pred_missing)/numberOfClasses) %>%
t() %>%
data.frame() %>%
mutate(label = test_label_missing + 1,
max_prob = max.col(., "last"))
confusionMatrix(factor(test_prediction_missing$max_prob),
factor(test_prediction_missing$label),
mode = "everything")
test_prediction_missing
test_pred_missing
test_prediction_missing
# read subset of data
pitches_2020_regular = readr::read_csv("data/pitches_2020_regular.csv")
pitches_2020_missing = readr::read_csv("data/pitches_2020_missing.csv")
pitches_2020_post = readr::read_csv("data/pitches_2020_post.csv")
sapply(pitches_2020_regular, class)
pitches_2020_regular = subset(pitches_2020_regular, select = -c(game_date,batter,pitcher))
pitches_2020_post = subset(pitches_2020_post, select = -c(game_date,batter,pitcher))
pitches_2020_missing = subset(pitches_2020_missing, select = -c(game_date,batter,pitcher))
pitches_2020_regular$pitch_type
pitches_2020_regular
test_pred
test_prediction
test_pred
test_matrix
test_prediction
test_label
test_data
test_label
dat$pitch_type
dat$pitch_type[-train_index_xgboost]
pitches_2020_regular
pitches_2020_regular[-train_index_xgboost]
pitches_2020_regular$pitch_type[-train_index_xgboost]
knitr::opts_chunk$set(echo = FALSE, fig.align = 'center')
# load packages
library("tidyverse")
library("caret")
library("rpart")
library("rpart.plot")
library("PRROC")
library("ROCR")
library("MLmetrics")
library("dplyr")
# read subset of data
pitches_2020_regular = readr::read_csv("data/pitches_2020_regular.csv")
pitches_2020_missing = readr::read_csv("data/pitches_2020_missing.csv")
pitches_2020_post = readr::read_csv("data/pitches_2020_post.csv")
pitches_2020_regular = subset(pitches_2020_regular, select = -c(game_date,batter,pitcher))
pitches_2020_post = subset(pitches_2020_post, select = -c(game_date,batter,pitcher))
pitches_2020_missing = subset(pitches_2020_missing, select = -c(game_date,batter,pitcher))
# Creating Train/Test dataset
set.seed((42))
trn_idx = createDataPartition(pitches_2020_regular$pitch_type, p = 0.80, list = TRUE)
pitches_2020_regular_trn = pitches_2020_regular[trn_idx$Resample1, ]
pitches_2020_regular_tst = pitches_2020_regular[-trn_idx$Resample1, ]
trn_idx_post = createDataPartition(pitches_2020_post$pitch_type, p = 0.80, list = TRUE)
pitches_2020_post_trn = pitches_2020_post[trn_idx_post$Resample1, ]
pitches_2020_post_tst = pitches_2020_post[-trn_idx_post$Resample1, ]
summary(pitches_2020_regular_trn)
summary(pitches_2020_post_trn)
est_idx = createDataPartition(pitches_2020_regular_trn$pitch_type, p = 0.80, list = TRUE)
pitches_2020_regular_est = pitches_2020_regular_trn[est_idx$Resample1, ]
pitches_2020_regular_val = pitches_2020_regular_trn[-est_idx$Resample1, ]
summary(pitches_2020_regular_est)
# coerce character variables to be factors
pitches_2020_regular_trn$pitch_type = factor(pitches_2020_regular_trn$pitch_type)
pitches_2020_regular_trn$release_speed = factor(pitches_2020_regular_trn$release_speed)
pitches_2020_regular_trn$release_pos_x = factor(pitches_2020_regular_trn$release_pos_x)
pitches_2020_regular_trn$release_pos_z = factor(pitches_2020_regular_trn$release_pos_z)
pitches_2020_regular_trn$pfx_x = factor(pitches_2020_regular_trn$pfx_x)
pitches_2020_regular_trn$pfx_z = factor(pitches_2020_regular_trn$pfx_z)
pitches_2020_regular_trn$vy0 = factor(pitches_2020_regular_trn$vy0)
pitches_2020_regular_trn$ax = factor(pitches_2020_regular_trn$ax)
pitches_2020_regular_trn$az = factor(pitches_2020_regular_trn$az)
pitches_2020_regular_trn$effective_speed = factor(pitches_2020_regular_trn$effective_speed)
pitches_2020_regular_trn$release_spin_rate = factor(pitches_2020_regular_trn$release_spin_rate)
pitches_2020_regular_trn_full = na.omit(pitches_2020_post_trn)
cv_5 = trainControl(method = "cv", number = 5)
pitch_tree_mod = train(form = pitch_type~.,
data = pitches_2020_regular_trn_full,
method = "rpart",
trControl = cv_5,
tuneLength = 10)
pitch_tree_mod
pitch_knn_mod = train(form = pitch_type~.,
data = pitches_2020_regular_trn_full,
method = "knn",
trControl = cv_5,
tuneLength = 10)
pitch_knn_mod
predict(pitch_tree_mod, pitches_2020_missing, type = "prob")
predict(pitch_knn_mod, pitches_2020_missing, type = "Class")
predict(pitch_knn_mod, pitches_2020_missing, type = "raw")
predict(pitch_tree_mod, pitches_2020_missing, type = "raw")
